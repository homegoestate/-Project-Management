<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°æ”¿å£«æ¡ˆä»¶ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .mono-font { font-family: 'Roboto Mono', monospace; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .company-tag-hg { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .company-tag-yc { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        /* Loading Overlay */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        /* Mock Mode Indicator */
        #mock-indicator { position: fixed; bottom: 10px; right: 10px; background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; z-index: 9999; pointer-events: none; opacity: 0.8; }
    </style>
</head>
<body class="antialiased h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-emerald-600 mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700">ç³»çµ±é€£ç·šä¸­...</h2>
        <p id="loading-text" class="text-slate-500 text-sm mt-2">æ­£åœ¨èˆ‡ Google è³‡æ–™åº«åŒæ­¥è³‡æ–™</p>
    </div>

    <!-- Login/Error Screen -->
    <div id="error-screen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-8 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-bold ph-warning text-3xl text-red-600"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">ç„¡æ³•å­˜å–ç³»çµ±</h2>
            <p id="error-msg" class="text-slate-600 mb-6">æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤ç³»çµ±ã€‚</p>
            <button onclick="location.reload()" class="bg-slate-800 text-white px-6 py-2 rounded hover:bg-slate-700">é‡æ–°æ•´ç†</button>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden flex-1 flex flex-col md:flex-row h-screen">
        <!-- Sidebar -->
        <aside class="bg-slate-800 text-white w-full md:w-64 flex-shrink-0 flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-700 flex items-center gap-3">
                <div class="w-8 h-8 bg-emerald-500 rounded flex items-center justify-center"><i class="ph-bold ph-stack text-white"></i></div>
                <span class="font-bold text-lg tracking-wide">æ¡ˆä»¶ç®¡ç†ä¸­å¿ƒ</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
                <button onclick="switchView('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded flex items-center gap-3 bg-slate-700/50 text-emerald-400" data-view="dashboard">
                    <i class="ph ph-chart-pie-slice text-xl"></i> ç‡Ÿé‹å„€è¡¨æ¿
                </button>
                <button onclick="switchView('cases')" class="nav-btn w-full text-left px-4 py-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700" data-view="cases">
                    <i class="ph ph-files text-xl"></i> æ¡ˆä»¶åˆ—è¡¨
                </button>
                <button onclick="switchView('accounting')" class="nav-btn w-full text-left px-4 py-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700" data-view="accounting">
                    <i class="ph ph-currency-circle-dollar text-xl"></i> æœƒè¨ˆå¸³å‹™è¡¨
                </button>
                <div id="admin-menu" class="hidden">
                    <p class="px-4 text-xs font-bold text-slate-500 mt-6 mb-2">ç³»çµ±ç®¡ç†</p>
                    <button onclick="switchView('users')" class="nav-btn w-full text-left px-4 py-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700" data-view="users">
                        <i class="ph ph-users-three text-xl"></i> äººå“¡æ¬Šé™ç®¡ç†
                    </button>
                    <button onclick="switchView('settings')" class="nav-btn w-full text-left px-4 py-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700" data-view="settings">
                        <i class="ph ph-gear text-xl"></i> åƒæ•¸è¨­å®š
                    </button>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-700 bg-slate-900/50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-xs font-bold text-white">U</div>
                    <div class="overflow-hidden">
                        <p id="user-name-display" class="text-sm font-medium truncate">è¼‰å…¥ä¸­...</p>
                        <p id="user-email-display" class="text-xs text-slate-400 truncate"></p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative">
            <header class="bg-white shadow-sm px-6 py-3 flex justify-between items-center z-10 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-slate-500">å…¬å¸ç¯©é¸ï¼š</span>
                    <select id="company-filter" class="bg-slate-100 rounded px-3 py-1.5 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-emerald-500">
                        <option value="all">ğŸ¢ æ‰€æœ‰å…¬å¸</option>
                        <option value="å®åœ‹">ğŸŸ¦ å®åœ‹åœ°æ”¿</option>
                        <option value="æ˜“ä¸">ğŸŸ§ æ˜“ä¸åœ°æ”¿</option>
                    </select>
                </div>
                <button onclick="openModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded text-sm font-bold shadow flex items-center gap-2">
                    <i class="ph-bold ph-plus"></i> æ–°å¢æ¡ˆä»¶
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <!-- Dashboard -->
                <div id="view-dashboard" class="view-section fade-in space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-5 rounded shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400">ç¸½ç‡Ÿæ”¶ (ä»£æ›¸è²»)</p>
                            <h3 id="kpi-revenue" class="text-2xl font-bold text-slate-800 mt-1 mono-font">NT$ 0</h3>
                        </div>
                        <div class="bg-white p-5 rounded shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400">é€²è¡Œä¸­æ¡ˆä»¶</p>
                            <h3 id="kpi-active" class="text-2xl font-bold text-blue-600 mt-1">0</h3>
                        </div>
                        <div class="bg-white p-5 rounded shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400">æ‡‰æ”¶å¸³æ¬¾</p>
                            <h3 id="kpi-receivable" class="text-2xl font-bold text-orange-500 mt-1 mono-font">NT$ 0</h3>
                        </div>
                         <div class="bg-white p-5 rounded shadow-sm border border-slate-200">
                            <p class="text-xs font-bold text-slate-400">Top éŠ€è¡Œ</p>
                            <h3 id="kpi-top-bank" class="text-lg font-bold text-slate-700 mt-2 truncate">-</h3>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded shadow-sm border border-slate-200">
                            <div class="chart-container"><canvas id="companyChart"></canvas></div>
                        </div>
                         <div class="bg-white p-6 rounded shadow-sm border border-slate-200">
                            <div class="chart-container"><canvas id="bankChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- Case List -->
                <div id="view-cases" class="view-section hidden fade-in space-y-4">
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="search-input" placeholder="æœå°‹..." class="flex-1 border p-2 rounded">
                    </div>
                    <div class="bg-white rounded shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-100 text-slate-600 font-bold uppercase text-xs">
                                    <tr>
                                        <th class="px-6 py-3">å…¬å¸</th>
                                        <th class="px-6 py-3">æ¡ˆè™Ÿ / æ—¥æœŸ</th>
                                        <th class="px-6 py-3">å®¢æˆ¶ / æ¨™çš„</th>
                                        <th class="px-6 py-3">æ‰¿è¾¦ / éŠ€è¡Œ</th>
                                        <th class="px-6 py-3">ç‹€æ…‹</th>
                                        <th class="px-6 py-3 text-right">è²»ç”¨</th>
                                        <th class="px-6 py-3 text-center">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="table-cases-body" class="divide-y divide-slate-100 text-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Accounting -->
                <div id="view-accounting" class="view-section hidden fade-in space-y-4">
                    <div class="flex justify-end"><button onclick="exportCSV()" class="text-sm bg-slate-800 text-white px-3 py-1 rounded">åŒ¯å‡º CSV</button></div>
                    <div class="bg-white rounded shadow-sm overflow-x-auto">
                        <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="bg-slate-800 text-white">
                                <tr>
                                    <th class="px-4 py-2">å…¬å¸</th><th class="px-4 py-2">æ¡ˆè™Ÿ</th><th class="px-4 py-2">å®¢æˆ¶</th>
                                    <th class="px-4 py-2 text-right">ä»£æ›¸è²»</th><th class="px-4 py-2 text-right">é æ”¶</th>
                                    <th class="px-4 py-2 text-right">å¯¦æ”¯</th><th class="px-4 py-2 text-right">çµé¤˜</th>
                                </tr>
                            </thead>
                            <tbody id="table-accounting-body" class="divide-y divide-slate-100 font-mono"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Users (Admin) -->
                <div id="view-users" class="view-section hidden fade-in space-y-6">
                    <div class="bg-white p-6 rounded shadow-sm max-w-md">
                        <h3 class="font-bold mb-4">æ–°å¢äººå“¡</h3>
                        <div class="flex gap-2">
                            <input id="new-user-email" placeholder="Email" class="border p-2 rounded flex-1">
                            <input id="new-user-name" placeholder="å§“å" class="border p-2 rounded w-24">
                            <select id="new-user-role" class="border p-2 rounded"><option value="user">User</option><option value="admin">Admin</option></select>
                            <button onclick="addUser()" class="bg-emerald-600 text-white px-4 rounded">æ–°å¢</button>
                        </div>
                    </div>
                    <div class="bg-white rounded shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100"><tr><th class="px-6 py-3">å§“å</th><th class="px-6 py-3">Email</th><th class="px-6 py-3">è§’è‰²</th><th class="px-6 py-3">ç‹€æ…‹</th><th class="px-6 py-3">æ“ä½œ</th></tr></thead>
                            <tbody id="user-list-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings -->
                <div id="view-settings" class="view-section hidden fade-in space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded shadow-sm">
                            <h3 class="font-bold mb-4">éŠ€è¡Œæ¸…å–® (é»æ“Šåˆªé™¤)</h3>
                            <div id="list-banks" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="bg-white p-6 rounded shadow-sm">
                            <h3 class="font-bold mb-4">æ‰¿è¾¦äººæ¸…å–® (é»æ“Šåˆªé™¤)</h3>
                            <div id="list-staff" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="case-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-slate-800" id="modal-title">æ¡ˆä»¶è³‡æ–™</h3>
                <button onclick="document.getElementById('case-modal').classList.add('hidden')"><i class="ph-bold ph-x"></i></button>
            </div>
            <form id="case-form" class="p-6 overflow-y-auto space-y-4">
                <input type="hidden" id="field-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500">å…¬å¸</label><select id="field-company" class="w-full border p-2 rounded"><option value="å®åœ‹">å®åœ‹</option><option value="æ˜“ä¸">æ˜“ä¸</option></select></div>
                    <div><label class="text-xs font-bold text-slate-500">æ—¥æœŸ</label><input type="date" id="field-date" required class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs font-bold text-slate-500">æ¡ˆè™Ÿ</label><input id="field-caseNo" class="w-full border p-2 rounded bg-slate-50" placeholder="è‡ªå‹•ç”Ÿæˆ"></div>
                    <div><label class="text-xs font-bold text-slate-500">å®¢æˆ¶</label><input id="field-client" required class="w-full border p-2 rounded"></div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="text-xs font-bold text-slate-500">æ‰¿è¾¦äºº</label><input list="dl-staff" id="field-staff" class="w-full border p-2 rounded"><datalist id="dl-staff"></datalist></div>
                    <div class="col-span-2"><label class="text-xs font-bold text-slate-500">éŠ€è¡Œ</label><input list="dl-banks" id="field-bank" class="w-full border p-2 rounded"><datalist id="dl-banks"></datalist></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div><label class="text-xs font-bold text-slate-500">é¡å‹</label><select id="field-type" class="w-full border p-2 rounded"><option value="è²·è³£ç§»è½‰">è²·è³£ç§»è½‰</option><option value="ç¹¼æ‰¿ç™»è¨˜">ç¹¼æ‰¿ç™»è¨˜</option><option value="æŠµæŠ¼è¨­å®š">æŠµæŠ¼è¨­å®š</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
                     <div><label class="text-xs font-bold text-slate-500">ç‹€æ…‹</label><select id="field-status" class="w-full border p-2 rounded"><option value="è¾¦ç†ä¸­">è¾¦ç†ä¸­</option><option value="å·²çµæ¡ˆ">å·²çµæ¡ˆ</option><option value="é€ä»¶ä¸­">é€ä»¶ä¸­</option></select></div>
                </div>
                <div><label class="text-xs font-bold text-slate-500">æ¨™çš„</label><input id="field-property" class="w-full border p-2 rounded"></div>
                <div class="bg-slate-50 p-4 rounded grid grid-cols-4 gap-2">
                    <div><label class="text-xs font-bold text-emerald-600">ä»£æ›¸è²»</label><input type="number" id="field-fee" value="0" class="w-full border p-1 rounded text-right"></div>
                    <div><label class="text-xs font-bold text-blue-600">é æ”¶</label><input type="number" id="field-prepaid" value="0" class="w-full border p-1 rounded text-right"></div>
                    <div><label class="text-xs font-bold text-red-500">å¯¦æ”¯</label><input type="number" id="field-actual" value="0" class="w-full border p-1 rounded text-right"></div>
                    <div><label class="text-xs font-bold text-slate-700">å·²æ”¶</label><input type="number" id="field-paid" value="0" class="w-full border p-1 rounded text-right"></div>
                </div>
                <div><label class="text-xs font-bold text-slate-500">å‚™è¨»</label><textarea id="field-note" class="w-full border p-2 rounded"></textarea></div>
                <div class="flex justify-end pt-4"><button type="submit" class="bg-slate-800 text-white px-6 py-2 rounded font-bold">å„²å­˜</button></div>
            </form>
        </div>
    </div>

    <script>
        let state = { users: [], cases: [], settings: [], user: null, filterComp: 'all' };
        let isMockMode = false;

        // --- Mock Data Generator (Simulation) ---
        const mockServer = {
            getSystemData: () => {
                // Initialize default Mock Data
                return {
                    currentUser: { 'Email': 'admin@test.com', 'å§“å': 'é è¦½ç®¡ç†å“¡', 'è§’è‰²': 'admin', 'ç‹€æ…‹': 'active' },
                    users: [
                        { 'Email': 'admin@test.com', 'å§“å': 'é è¦½ç®¡ç†å“¡', 'è§’è‰²': 'admin', 'ç‹€æ…‹': 'active' }
                    ],
                    settings: [
                        { 'é¡åˆ¥': 'éŠ€è¡Œ', 'åç¨±': 'å°ç£éŠ€è¡Œ' }, { 'é¡åˆ¥': 'éŠ€è¡Œ', 'åç¨±': 'ä¸­åœ‹ä¿¡è¨—' },
                        { 'é¡åˆ¥': 'æ‰¿è¾¦äºº', 'åç¨±': 'ç‹å¤§æ˜' }
                    ],
                    cases: [
                        { id: '1', 'å…¬å¸': 'å®åœ‹', 'æ—¥æœŸ': new Date().toISOString().split('T')[0], 'æ¡ˆè™Ÿ': 'HG-001', 'å®¢æˆ¶': 'ç¯„ä¾‹å®¢æˆ¶', 'é¡å‹': 'è²·è³£ç§»è½‰', 'ç‹€æ…‹': 'è¾¦ç†ä¸­', 'ä»£æ›¸è²»': 12000, 'é æ”¶': 15000, 'å¯¦æ”¯': 2000, 'å·²æ”¶': 0, 'éŠ€è¡Œ': 'å°ç£éŠ€è¡Œ', 'æ‰¿è¾¦äºº': 'ç‹å¤§æ˜', 'æ¨™çš„': 'æ¸¬è©¦åœ°å€1' }
                    ]
                };
            },
            saveCase: (data) => {
                // In Mock mode, we just push to local state array for visual feedback
                const idx = state.cases.findIndex(c => String(c.id) === String(data.id));
                if(idx > -1) state.cases[idx] = data;
                else state.cases.unshift({ ...data, id: String(Date.now()) });
                
                // Auto memory simulation
                if(data.bank && !state.settings.find(s=>s.åç¨±===data.bank)) state.settings.push({é¡åˆ¥:'éŠ€è¡Œ', åç¨±:data.bank});
                if(data.staff && !state.settings.find(s=>s.åç¨±===data.staff)) state.settings.push({é¡åˆ¥:'æ‰¿è¾¦äºº', åç¨±:data.staff});
                
                return { ...state };
            },
            addUser: (email, name, role) => {
                state.users.push({ 'Email': email, 'å§“å': name, 'è§’è‰²': role, 'ç‹€æ…‹': 'active' });
                return { ...state };
            },
            updateUserStatus: (email, status) => {
                const u = state.users.find(u => u.Email === email);
                if(u) u.ç‹€æ…‹ = status;
                return { ...state };
            },
            deleteSetting: (cat, val) => {
                state.settings = state.settings.filter(s => !(s.é¡åˆ¥ === cat && s.åç¨± === val));
                return { ...state };
            }
        };

        // --- GAS Wrapper with Fallback ---
        function runGAS(func, ...args) {
            return new Promise((resolve, reject) => {
                // Check if running in real GAS environment
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        [func](...args);
                } else {
                    // Fallback to Mock Server
                    console.warn(`[Mock Mode] Calling backend: ${func}`, args);
                    if (!isMockMode) {
                        isMockMode = true;
                        const badge = document.createElement('div');
                        badge.id = 'mock-indicator';
                        badge.textContent = 'æ¨¡æ“¬é è¦½æ¨¡å¼ (ç„¡å¾Œç«¯)';
                        document.body.appendChild(badge);
                    }
                    
                    setTimeout(() => {
                        try {
                            const result = mockServer[func](...args);
                            resolve(result);
                        } catch (e) {
                            reject(e);
                        }
                    }, 600); // Simulate network delay
                }
            });
        }

        async function init() {
            try {
                // Start loading
                const data = await runGAS('getSystemData');
                state = { ...state, ...data, user: data.currentUser };
                
                // UI Setup
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-name-display').textContent = state.user['å§“å'];
                document.getElementById('user-email-display').textContent = state.user['Email'];
                
                if (state.user['è§’è‰²'] === 'admin') document.getElementById('admin-menu').classList.remove('hidden');
                
                renderAll();
            } catch (err) {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('error-screen').classList.remove('hidden');
                document.getElementById('error-msg').textContent = err.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤';
            }
        }

        function renderAll() {
            const list = state.cases.filter(c => {
                const matchComp = state.filterComp === 'all' || c['å…¬å¸'] === state.filterComp;
                const search = document.getElementById('search-input').value.toLowerCase();
                const matchSearch = !search || Object.values(c).some(v => String(v).toLowerCase().includes(search));
                return matchComp && matchSearch;
            }).sort((a,b) => new Date(b['æ—¥æœŸ']) - new Date(a['æ—¥æœŸ']));

            renderDashboard(list);
            renderCases(list);
            renderAccounting(list);
            renderSettings();
            if(state.user['è§’è‰²']==='admin') renderUsers();
            updateDatalists();
        }

        // Render Functions
        function renderDashboard(list) {
            const rev = list.reduce((a,c) => a + Number(c['ä»£æ›¸è²»']||0), 0);
            const act = list.filter(c => c['ç‹€æ…‹']!=='å·²çµæ¡ˆ').length;
            const rec = list.reduce((a,c) => a + ((Number(c['ä»£æ›¸è²»'])+Number(c['å¯¦æ”¯'])) - Number(c['å·²æ”¶'])), 0);
            
            document.getElementById('kpi-revenue').textContent = 'NT$ ' + rev.toLocaleString();
            document.getElementById('kpi-active').textContent = act;
            document.getElementById('kpi-receivable').textContent = 'NT$ ' + rec.toLocaleString();

            // Charts
            const hg = list.filter(c=>c['å…¬å¸']==='å®åœ‹').length;
            const yc = list.filter(c=>c['å…¬å¸']==='æ˜“ä¸').length;
            
            if(window.chartComp) window.chartComp.destroy();
            window.chartComp = new Chart(document.getElementById('companyChart'), {
                type: 'doughnut',
                data: { labels: ['å®åœ‹','æ˜“ä¸'], datasets: [{ data:[hg,yc], backgroundColor:['#3b82f6','#f97316'] }] },
                options: { maintainAspectRatio: false }
            });

            // Banks
            const banks = {};
            list.forEach(c => { if(c['éŠ€è¡Œ']) banks[c['éŠ€è¡Œ']] = (banks[c['éŠ€è¡Œ']]||0)+1; });
            const topB = Object.entries(banks).sort((a,b)=>b[1]-a[1]).slice(0,5);
            document.getElementById('kpi-top-bank').textContent = topB[0] ? topB[0][0] : '-';

            if(window.chartBank) window.chartBank.destroy();
            window.chartBank = new Chart(document.getElementById('bankChart'), {
                type: 'bar',
                data: { labels: topB.map(x=>x[0]), datasets: [{ label:'ä»¶æ•¸', data:topB.map(x=>x[1]), backgroundColor:'#10b981' }] },
                options: { maintainAspectRatio: false }
            });
        }

        function renderCases(list) {
            const tbody = document.getElementById('table-cases-body');
            tbody.innerHTML = list.map(c => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${c['å…¬å¸']==='å®åœ‹'?'company-tag-hg':'company-tag-yc'}">${c['å…¬å¸']}</span></td>
                    <td class="px-6 py-4"><div>${c['æ¡ˆè™Ÿ']}</div><div class="text-xs text-slate-400">${new Date(c['æ—¥æœŸ']).toLocaleDateString()}</div></td>
                    <td class="px-6 py-4"><div>${c['å®¢æˆ¶']}</div><div class="text-xs text-slate-400">${c['æ¨™çš„']}</div></td>
                    <td class="px-6 py-4 text-xs">ğŸ‘¤ ${c['æ‰¿è¾¦äºº']||'-'}<br>ğŸ¦ ${c['éŠ€è¡Œ']||'-'}</td>
                    <td class="px-6 py-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${c['ç‹€æ…‹']}</span></td>
                    <td class="px-6 py-4 text-right font-mono">NT$ ${(Number(c['ä»£æ›¸è²»'])+Number(c['å¯¦æ”¯'])).toLocaleString()}</td>
                    <td class="px-6 py-4 text-center"><button onclick="editCase('${c.id}')" class="text-blue-600"><i class="ph-bold ph-pencil-simple"></i></button></td>
                </tr>
            `).join('');
        }

        function renderAccounting(list) {
            document.getElementById('table-accounting-body').innerHTML = list.map(c => {
                const bal = (Number(c['ä»£æ›¸è²»'])+Number(c['å¯¦æ”¯'])) - Number(c['å·²æ”¶']);
                return `<tr class="border-b hover:bg-yellow-50">
                    <td class="px-4 py-2 font-bold ${c['å…¬å¸']==='å®åœ‹'?'text-blue-700':'text-orange-700'}">${c['å…¬å¸']}</td>
                    <td class="px-4 py-2">${c['æ¡ˆè™Ÿ']}</td><td class="px-4 py-2">${c['å®¢æˆ¶']}</td>
                    <td class="px-4 py-2 text-right text-emerald-700">${Number(c['ä»£æ›¸è²»']).toLocaleString()}</td>
                    <td class="px-4 py-2 text-right text-blue-700">${Number(c['é æ”¶']).toLocaleString()}</td>
                    <td class="px-4 py-2 text-right text-red-700">${Number(c['å¯¦æ”¯']).toLocaleString()}</td>
                    <td class="px-4 py-2 text-right font-bold ${bal>0?'text-red-600':'text-slate-400'}">${bal.toLocaleString()}</td>
                </tr>`;
            }).join('');
        }

        function renderUsers() {
            document.getElementById('user-list-body').innerHTML = state.users.map(u => `
                <tr class="border-b">
                    <td class="px-6 py-3 font-bold">${u['å§“å']}</td><td class="px-6 py-3">${u['Email']}</td>
                    <td class="px-6 py-3"><span class="bg-slate-100 px-2 rounded text-xs">${u['è§’è‰²']}</span></td>
                    <td class="px-6 py-3 text-green-600 font-bold">${u['ç‹€æ…‹']}</td>
                    <td class="px-6 py-3"><button onclick="toggleUser('${u['Email']}', '${u['ç‹€æ…‹']}')" class="text-xs border px-2 rounded hover:bg-slate-100">åˆ‡æ›ç‹€æ…‹</button></td>
                </tr>
            `).join('');
        }

        function renderSettings() {
            const makeTags = (cat, divId) => {
                const items = state.settings.filter(s => s['é¡åˆ¥'] === cat);
                document.getElementById(divId).innerHTML = items.map(s => `
                    <div onclick="delSetting('${cat}', '${s['åç¨±']}')" class="border px-3 py-1 rounded cursor-pointer hover:bg-red-50 hover:text-red-500 flex items-center gap-2 group">
                        ${s['åç¨±']} <i class="ph-bold ph-x opacity-0 group-hover:opacity-100 text-xs"></i>
                    </div>
                `).join('');
            };
            makeTags('éŠ€è¡Œ', 'list-banks');
            makeTags('æ‰¿è¾¦äºº', 'list-staff');
        }

        function updateDatalists() {
            const fill = (cat, id) => {
                const opts = state.settings.filter(s => s['é¡åˆ¥'] === cat).map(s => `<option value="${s['åç¨±']}">`);
                document.getElementById(id).innerHTML = opts.join('');
            };
            fill('éŠ€è¡Œ', 'dl-banks'); fill('æ‰¿è¾¦äºº', 'dl-staff');
        }

        // Actions
        async function addUser() {
            const email = document.getElementById('new-user-email').value;
            const name = document.getElementById('new-user-name').value;
            const role = document.getElementById('new-user-role').value;
            if(!email) return alert('è«‹è¼¸å…¥ Email');
            
            try {
                const newData = await runGAS('addUser', email, name, role);
                state = { ...state, ...newData };
                renderUsers();
                alert('æ–°å¢æˆåŠŸ');
            } catch(e) { alert(e.message); }
        }

        async function toggleUser(email, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
            const newData = await runGAS('updateUserStatus', email, newStatus);
            state = { ...state, ...newData };
            renderUsers();
        }

        async function delSetting(cat, val) {
            if(!confirm(`åˆªé™¤ ${val}?`)) return;
            const newData = await runGAS('deleteSetting', cat, val);
            state = { ...state, ...newData };
            renderAll();
        }

        function editCase(id) {
            const c = state.cases.find(x => String(x.id) === String(id));
            if(!c) return;
            document.getElementById('case-modal').classList.remove('hidden');
            
            const fields = {
                id: c.id, company: c['å…¬å¸'], date: new Date(c['æ—¥æœŸ']).toISOString().split('T')[0],
                caseNo: c['æ¡ˆè™Ÿ'], client: c['å®¢æˆ¶'], staff: c['æ‰¿è¾¦äºº'], bank: c['éŠ€è¡Œ'],
                type: c['é¡å‹'], status: c['ç‹€æ…‹'], property: c['æ¨™çš„'],
                fee: c['ä»£æ›¸è²»'], prepaid: c['é æ”¶'], actual: c['å¯¦æ”¯'], paid: c['å·²æ”¶'], note: c['å‚™è¨»']
            };
            
            for(let k in fields) {
                if(document.getElementById('field-'+k)) document.getElementById('field-'+k).value = fields[k];
            }
        }
        
        function openModal() {
            document.getElementById('case-modal').classList.remove('hidden');
            document.getElementById('case-form').reset();
            document.getElementById('field-id').value = Date.now(); // New ID
            document.getElementById('field-date').value = new Date().toISOString().split('T')[0];
        }

        document.getElementById('case-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const getVal = (id) => document.getElementById('field-'+id).value;
            const data = {
                id: getVal('id'), company: getVal('company'), date: getVal('date'),
                caseNo: getVal('caseNo') || 'AUTO', clientName: getVal('client'),
                staff: getVal('staff'), bank: getVal('bank'), caseType: getVal('type'),
                status: getVal('status'), property: getVal('property'),
                serviceFee: getVal('fee'), prepaidFee: getVal('prepaid'),
                actualFee: getVal('actual'), paidAmount: getVal('paid'), note: getVal('note')
            };
            
            document.getElementById('case-modal').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                const newData = await runGAS('saveCase', data);
                state = { ...state, ...newData };
                renderAll();
            } catch(e) { alert('å„²å­˜å¤±æ•—: ' + e.message); }
            
            document.getElementById('loading-overlay').classList.add('hidden');
        });

        function exportCSV() {
            const list = state.cases.filter(c => state.filterComp === 'all' || c['å…¬å¸'] === state.filterComp);
            let csvContent = "\uFEFFå…¬å¸,æ¡ˆè™Ÿ,æ—¥æœŸ,å®¢æˆ¶,æ‰¿è¾¦äºº,éŠ€è¡Œ,ä»£æ›¸è²»(æ”¶),é æ”¶è¦è²»,å¯¦æ”¯è¦è²»(ä»˜),å·²æ”¶é‡‘é¡,å‚™è¨»\n";
            
            list.forEach(c => {
                const row = [
                    c['å…¬å¸'], c['æ¡ˆè™Ÿ'], new Date(c['æ—¥æœŸ']).toISOString().split('T')[0], c['å®¢æˆ¶'], 
                    c['æ‰¿è¾¦äºº'], c['éŠ€è¡Œ'], c['ä»£æ›¸è²»'], c['é æ”¶'], c['å¯¦æ”¯'], c['å·²æ”¶'], (c['å‚™è¨»']||'').replace(/\n/g, ' ')
                ].map(v => `"${v||''}"`).join(',');
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æ¡ˆä»¶è³‡æ–™åŒ¯å‡º_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        // Listeners
        document.getElementById('company-filter').addEventListener('change', (e) => { state.filterComp = e.target.value; renderAll(); });
        document.getElementById('search-input').addEventListener('input', renderAll);
        
        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
        }

        // Start
        init();
    </script>
</body>
</html>
